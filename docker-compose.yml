services:
  sandbox-server:
    build: .
    entrypoint: []
    command: ["bun", "run", "src/server.ts"]
    ports:
      - "3700:3700"   # Permission server + Web UI
      - "3701:3701"   # HTTP proxy
    volumes:
      - ./data:/sandbox/data
      - ./sandbox.config.json:/sandbox/sandbox.config.json
      - ${HOST_PROJECT:-./../}:/workspace/lower
      - workspace:/workspace/merged
    environment:
      - SERVER_PORT=3700
      - PROXY_PORT=3701
      - PROXY_INLINE=true
      - MAX_UPTIME=${MAX_UPTIME:-}
    working_dir: /sandbox
    networks:
      - sandbox-net
      - external-net

  agent:
    build: .
    depends_on:
      - sandbox-server
    volumes:
      - ${HOST_PROJECT:-./../}:/workspace/lower:ro
      - workspace:/workspace/merged
      - agent-data:/data
    environment:
      - HTTP_PROXY=http://sandbox-server:3701
      - HTTPS_PROXY=http://sandbox-server:3701
      - NO_PROXY=api.anthropic.com,registry.npmjs.org,registry.npmmirror.com
      - SANDBOX_API=http://sandbox-server:3700
    networks:
      - sandbox-net
      - external-net
    # Override with your agent command:
    # docker compose run agent <your-agent-command>
    command: ["bash"]
    stdin_open: true
    tty: true

networks:
  sandbox-net:
    internal: true   # No external access
  external-net:      # Default bridge with internet access

volumes:
  workspace:
  agent-data:
